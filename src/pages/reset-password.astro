---
import "../styles/global.css";

const url = Astro.url;
const userId = url.searchParams.get("userId");
const secret = url.searchParams.get("secret");

const isValid = Boolean(userId && secret);
---

<html lang="en">
  <body
    class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900
           flex items-center justify-center px-4"
  >
    <div
      class="w-full max-w-sm sm:max-w-md
             bg-slate-900/85 backdrop-blur
             border border-slate-700
             rounded-2xl shadow-2xl
             p-6 sm:p-8"
    >
      <h2
        class="text-xl sm:text-2xl font-semibold text-white
               mb-1 text-center"
      >
        Reset Password
      </h2>

      <p
        class="text-slate-400 mb-6 text-sm text-center"
      >
        Enter a new password for your account
      </p>

      {!isValid ? (
        <div
          class="bg-red-500/10 border border-red-500/30
                 text-red-400 rounded-lg
                 p-4 text-sm
                 flex items-center gap-3"
        >
          <svg
            class="shrink-0"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path d="M18.36 19.78L12 13.41l-6.36 6.37-1.42-1.42L10.59 12 4.22 5.64l1.42-1.42L12 10.59l6.36-6.36 1.41 1.41L13.41 12l6.36 6.36z"/>
          </svg>
          <span>Invalid or expired reset link.</span>
        </div>
      ) : (
        <>
          <form id="resetForm" class="space-y-4">
            <div>
              <label class="block text-sm text-slate-300 mb-1">
                New Password
              </label>

              <input
                type="password"
                id="password"
                placeholder="••••••••"
                required
                class="w-full rounded-lg
                       bg-slate-800 border border-slate-700
                       px-4 py-3
                       text-white placeholder-slate-500
                       focus:outline-none focus:ring-2 focus:ring-indigo-500"
              />
            </div>

            <button
              type="submit"
              class="w-full bg-indigo-600 hover:bg-indigo-500
                     transition rounded-lg
                     py-3 font-medium text-white
                     active:scale-[0.98]"
            >
              Reset Password
            </button>
          </form>

          <p
            id="msg"
            class="mt-4 text-sm text-center"
          ></p>
        </>
      )}

      <p
        class="mt-6 text-center text-xs text-slate-500"
      >
        Secured by Speach Wave
      </p>
    </div>

    {isValid && (
      <script type="module">
        import { Client, Account } from "https://cdn.jsdelivr.net/npm/appwrite@17.0.0/+esm";

        const client = new Client()
          .setEndpoint("https://appwrite.yourdomain.com/v1")
          .setProject("PROJECT_ID");

        const account = new Account(client);

        const params = new URLSearchParams(window.location.search);
        const userId = params.get("userId");
        const secret = params.get("secret");

        document
          .getElementById("resetForm")
          ?.addEventListener("submit", async (e) => {
            e.preventDefault();

            const password = document.getElementById("password").value;
            const msg = document.getElementById("msg");

            msg.textContent = "Resetting password...";
            msg.className = "mt-4 text-sm text-center text-slate-400";

            try {
              await account.updateRecovery(
                userId,
                secret,
                password,
                password
              );

              msg.textContent =
                "✅ Password reset successful. Redirecting to login...";
              msg.className =
                "mt-4 text-sm text-center text-green-400";

              setTimeout(() => {
                window.location.href = "/login";
              }, 2000);
            } catch (err) {
              msg.textContent =
                err.message || "Something went wrong";
              msg.className =
                "mt-4 text-sm text-center text-red-400";
            }
          });
      </script>
    )}
  </body>
</html>
