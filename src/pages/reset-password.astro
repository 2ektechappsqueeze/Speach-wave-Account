---
import "../styles/global.css";
export const prerender = false;

const url = Astro.url;
const userId = url.searchParams.get("userId");
const secret = url.searchParams.get("secret");
// console.log("userId:", userId, "secret:", secret , url);

const isValid = Boolean(userId && secret);
---

<html lang="en">
  <body
    class="min-h-screen bg-[#fcfcfc] flex items-center justify-center p-6 font-sans"
  >
    <div
      class="w-full max-w-[440px] bg-white rounded-4xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] p-8 sm:p-10"
    >
      <h1
        class="text-2xl sm:text-3xl font-bold text-[#1a1a1a] mb-3 text-center tracking-tight"
      >
        Reset your password
      </h1>

      <p class="text-[#666] mb-8 text-center text-[15px] leading-relaxed">
        Enter a new password for your SpeechWave account.
      </p>

      {!isValid ? (
        <div
          class="bg-red-50 border border-red-100 text-red-600 rounded-xl p-4 text-sm flex items-center gap-3 mb-6"
        >
          <svg
            class="shrink-0"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <span class="font-medium">Invalid or expired reset link.</span>
        </div>
      ) : (
        <>
          <form id="resetForm" class="space-y-6">
            <div class="space-y-1.5">
              <label class="block text-sm text-[#4a4a4a] font-semibold ml-1">
                New password
              </label>
              <input
                type="password"
                id="password"
                required
                class="w-full rounded-xl bg-white border border-[#e5e5e5] px-4 py-3 text-[#333] placeholder-gray-400 focus:outline-none focus:border-black focus:ring-1 focus:ring-black transition-all text-[15px]"
              />
            </div>

            <div class="space-y-1.5">
              <label class="block text-sm text-[#4a4a4a] font-semibold ml-1">
                Confirm new password
              </label>
              <input
                type="password"
                id="confirmPassword"
                required
                class="w-full rounded-xl bg-white border border-[#e5e5e5] px-4 py-3 text-[#333] placeholder-gray-400 focus:outline-none focus:border-black focus:ring-1 focus:ring-black transition-all text-[15px]"
              />
            </div>

            <button
              type="submit"
              class="w-full bg-[#111] text-white rounded-xl py-3.5 text-[15px] font-semibold hover:bg-black transition-all active:scale-[0.98] mt-2"
            >
              Reset Password
            </button>
          </form>

          <p id="msg" class="mt-6 text-center text-sm font-medium"></p>
        </>
      )}

      <!-- <div class="mt-8 pt-6 border-t border-gray-50 flex flex-col items-center gap-4">
        <p class="text-gray-400 text-[11px] font-medium tracking-wider uppercase">
          Secured by Speech Wave
        </p>
      </div> -->
    </div>

    {
      isValid && (
        <script type="module">
          import {
            Client,
            Account,
          } from "https://cdn.jsdelivr.net/npm/appwrite@17.0.0/+esm";

          const client = new Client()
            .setEndpoint("https://appwritev2.omneuroai.com/v1")
            .setProject("693016d000015836421d");

          const account = new Account(client);

          const params = new URLSearchParams(window.location.search);
          const userId = params.get("userId");
          const secret = params.get("secret");

          document
            .getElementById("resetForm")
            ?.addEventListener("submit", async (e) => {
              e.preventDefault();

              const password = document.getElementById("password").value;
              const confirmPassword =
                document.getElementById("confirmPassword").value;
              const msg = document.getElementById("msg");

              if (password !== confirmPassword) {
                msg.textContent = "Passwords do not match.";
                msg.className = "mt-8 text-center text-[15px] text-red-500 font-medium";
                return;
              }

              msg.textContent = "Updating your password...";
              msg.className = "mt-8 text-center text-[15px] text-gray-500 font-medium";

              try {
                await account.updateRecovery(
                  userId,
                  secret,
                  password,
                  confirmPassword
                );

                msg.textContent = "Password reset successful! Redirecting...";
                msg.className =
                  "mt-8 text-center text-[15px] text-green-600 font-medium";

                setTimeout(() => {
                  window.location.href = "/";
                }, 2000);
              } catch (err) {
                msg.textContent = err.message || "Failed to reset password.";
                msg.className =
                  "mt-8 text-center text-[15px] text-red-500 font-medium";
              }
            });
        </script>
      )
    }
  </body>
</html>
