---
import "../styles/global.css";
export const prerender = false;

const url = Astro.url;
const userId = url.searchParams.get("userId");
const secret = url.searchParams.get("secret");

const hasParams = Boolean(userId && secret);
---

<html lang="en">
  <body
    class="min-h-screen bg-[#fcfcfc] flex items-center justify-center p-6 font-sans"
  >
    <div
      class="w-full max-w-[440px] bg-white rounded-4xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] p-8 sm:p-10"
    >
      <h1
        class="text-2xl sm:text-3xl font-bold text-[#1a1a1a] mb-3 text-center tracking-tight"
      >
        Verify your account
      </h1>

      <p class="text-[#666] mb-8 text-center text-[15px] leading-relaxed">
        Click the button below to verify your SpeechWave account.
      </p>

      {!hasParams ? (
        <div
          class="bg-red-50 border border-red-100 text-red-600 rounded-xl p-4 text-sm flex items-center gap-3 mb-6"
        >
          <svg
            class="shrink-0"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <span class="font-medium">Invalid or expired verification link.</span>
        </div>
      ) : (
        <>
          <div class="space-y-6">
            <button
              id="verifyBtn"
              class="w-full bg-[#111] text-white rounded-xl py-3.5 text-[15px] font-semibold hover:bg-black transition-all active:scale-[0.98]"
            >
              Verify Account
            </button>
          </div>

          <p id="msg" class="mt-6 text-center text-sm font-medium"></p>
        </>
      )}
    </div>

    {
      hasParams && (
        <script type="module">
          import {
            Client,
            Account,
          } from "https://cdn.jsdelivr.net/npm/appwrite@17.0.0/+esm";

          const client = new Client()
            .setEndpoint("https://appwritev2.omneuroai.com/v1")
            .setProject("693016d000015836421d");

          const account = new Account(client);

          const params = new URLSearchParams(window.location.search);
          const userId = params.get("userId");
          const secret = params.get("secret");

          const verifyBtn = document.getElementById("verifyBtn");
          const msg = document.getElementById("msg");

          verifyBtn?.addEventListener("click", async () => {
            verifyBtn.disabled = true;
            verifyBtn.innerHTML = `
              <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Verifying...
            `;
            
            msg.textContent = "";

            try {
              await account.updateVerification(userId, secret);

              msg.textContent = "Verification successful! Redirecting...";
              msg.className = "mt-6 text-center text-[15px] text-green-600 font-medium";
              
              verifyBtn.textContent = "Verified";
              verifyBtn.classList.remove("bg-[#111]", "hover:bg-black");
              verifyBtn.classList.add("bg-green-600", "hover:bg-green-700");

              setTimeout(() => {
                window.location.href = "/";
              }, 2000);
            } catch (err) {
              console.error(err);
              msg.textContent = err.message || "Failed to verify account.";
              msg.className = "mt-6 text-center text-[15px] text-red-500 font-medium";
              
              verifyBtn.disabled = false;
              verifyBtn.textContent = "Verify Account";
            }
          });
        </script>
      )
    }
  </body>
</html>
